{% extends "base.html" %}
{% block content %}

<div class="card">
    <h2>Add Student Marks</h2>

    {% if error %}
    <p style="color: red;">{{ error }}</p>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <label>Student:</label>
        <select name="student" id="studentSelect">
            {% for student in students %}
                <option value="{{ student.id }}">
                    {{ student.first_name }} {{ student.last_name }}
                </option>
            {% endfor %}
        </select>

        <label>Exam Schedule:</label>
        <select name="exam_schedule" id="examScheduleSelect"></select>

        <label>Marks Obtained:</label>
        <input type="number" name="marks" step="0.01">

        <p id="scheduleHint" style="margin-top: 8px; color: #334155;"></p>

        <br><br>
        <button type="submit">Save Marks</button>
    </form>
</div>

{{ schedule_map|json_script:"scheduleMapData" }}
<script>
    const studentSelect = document.getElementById('studentSelect');
    const examScheduleSelect = document.getElementById('examScheduleSelect');
    const scheduleHint = document.getElementById('scheduleHint');
    const scheduleMap = JSON.parse(document.getElementById('scheduleMapData').textContent);

    function updateScheduleHint() {
        const selectedOption = examScheduleSelect.options[examScheduleSelect.selectedIndex];
        if (!selectedOption) {
            scheduleHint.textContent = 'No exam schedule available for this student.';
            return;
        }
        const totalMarks = selectedOption.dataset.totalMarks;
        const subject = selectedOption.dataset.subject;
        const examName = selectedOption.dataset.examName;
        scheduleHint.textContent = `Subject: ${subject} | Exam: ${examName} | Total Marks: ${totalMarks}`;
    }

    function loadSchedules() {
        const selectedStudentId = studentSelect.value;
        const schedules = scheduleMap[selectedStudentId] || [];
        examScheduleSelect.innerHTML = '';
        schedules.forEach((schedule) => {
            const option = document.createElement('option');
            option.value = schedule.id;
            option.textContent = schedule.label;
            option.dataset.subject = schedule.subject;
            option.dataset.examName = schedule.exam_name;
            option.dataset.totalMarks = schedule.total_marks;
            examScheduleSelect.appendChild(option);
        });

        updateScheduleHint();
    }

    studentSelect.addEventListener('change', loadSchedules);
    examScheduleSelect.addEventListener('change', updateScheduleHint);
    loadSchedules();
</script>

{% endblock %}
